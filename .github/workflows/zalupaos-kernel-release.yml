# .github/workflows/zalupaos-tux-kernel.yml
name: Build ZalupaOS Kernel with Tux

on:
  push:
    tags: ['v*', 'zalupaos-*']
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-tux-kernel:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libssl-dev libelf-dev bc wget
          
    - name: Get version
      id: version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION="${GITHUB_REF#refs/tags/}"
        else
          VERSION="zalupaos-$(date +%Y.%m.%d)-tux"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "KERNEL_VERSION=6.1.58" >> $GITHUB_ENV
        
    - name: Download kernel
      run: |
        wget -q https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-${{ env.KERNEL_VERSION }}.tar.xz
        tar -xf linux-${{ env.KERNEL_VERSION }}.tar.xz
        echo "KERNEL_DIR=linux-${{ env.KERNEL_VERSION }}" >> $GITHUB_ENV
        
    - name: Configure kernel with Tux
      run: |
        cd $KERNEL_DIR
        make allnoconfig
        
        # Обов'язкові опції
        ./scripts/config --enable CONFIG_64BIT
        ./scripts/config --enable CONFIG_SERIAL_8250
        ./scripts/config --enable CONFIG_SERIAL_8250_CONSOLE
        ./scripts/config --enable CONFIG_PRINTK
        ./scripts/config --enable CONFIG_TTY
        
        # Tux логотип
        ./scripts/config --enable CONFIG_LOGO
        ./scripts/config --enable CONFIG_LOGO_LINUX_CLUT224
        ./scripts/config --enable CONFIG_FB
        ./scripts/config --enable CONFIG_FB_SIMPLE
        
    - name: Build kernel
      run: |
        cd $KERNEL_DIR
        make -j$(nproc) bzImage
        
    - name: Create release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.VERSION }}
        name: "ZalupaOS Tux Kernel ${{ env.VERSION }}"
        body: |
          # ZalupaOS Kernel with Tux
          
          **Version:** ${{ env.VERSION }}
          **Feature:** Tux logo included
          
          ## Run with Tux logo:
          ```bash
          qemu-system-x86_64 -kernel bzImage -append "console=tty0"
          ```
        prerelease: true
        files: |
          ${{ env.KERNEL_DIR }}/arch/x86/boot/bzImage