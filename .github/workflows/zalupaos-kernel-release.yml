# .github/workflows/zalupaos-kernel-release.yml
name: Build ZalupaOS Kernel Release

on:
  push:
    tags: ['v*', 'zalupaos-*']
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Тип релізу'
        required: true
        default: 'beta'
        type: choice
        options:
          - stable
          - beta
          - alpha

permissions:
  contents: write

jobs:
  build-zalupaos-kernel:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout ZalupaOS
      uses: actions/checkout@v4
      
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libncurses-dev \
          flex \
          bison \
          libssl-dev \
          libelf-dev \
          bc \
          wget
          
    - name: Determine ZalupaOS version
      id: version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION="${GITHUB_REF#refs/tags/}"
        else
          COMMIT_SHORT="${GITHUB_SHA:0:8}"
          VERSION="zalupaos-$(date +%Y.%m.%d)-${{ github.event.inputs.release_type || 'beta' }}+${COMMIT_SHORT}"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "KERNEL_VERSION=6.1.58" >> $GITHUB_ENV
        
    - name: Download Linux kernel
      run: |
        wget -q https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-${{ env.KERNEL_VERSION }}.tar.xz
        tar -xf linux-${{ env.KERNEL_VERSION }}.tar.xz
        echo "KERNEL_DIR=linux-${{ env.KERNEL_VERSION }}" >> $GITHUB_ENV
        
    - name: Configure ZalupaOS kernel
      run: |
        cd $KERNEL_DIR
        make defconfig
        
        # Мінімальна конфігурація
        ./scripts/config --disable CONFIG_STACK_VALIDATION
        ./scripts/config --disable CONFIG_UNWINDER_ORC
        ./scripts/config --disable CONFIG_DEBUG_INFO
        ./scripts/config --disable CONFIG_MODULES
        ./scripts/config --disable CONFIG_BLK_DEV_INITRD
        
        # Обов'язкові опції
        ./scripts/config --enable CONFIG_SERIAL_8250
        ./scripts/config --enable CONFIG_SERIAL_8250_CONSOLE
        ./scripts/config --enable CONFIG_PRINTK
        ./scripts/config --enable CONFIG_TTY
        ./scripts/config --enable CONFIG_64BIT
        
        # Назва системи
        ./scripts/config --set-str CONFIG_LOCALVERSION "-zalupaos"
        
    - name: Build ZalupaOS kernel
      run: |
        cd $KERNEL_DIR
        make -j$(nproc) bzImage
        
    - name: Create ZalupaOS release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.VERSION }}
        name: "ZalupaOS Kernel ${{ env.VERSION }}"
        body: |
          # ZalupaOS Kernel ${{ env.VERSION }}
          
          **Версія ядра:** ${{ env.VERSION }}  
          **Базове ядро Linux:** ${{ env.KERNEL_VERSION }}  
          **Дата збірки:** $(date -u "+%Y-%m-%d %H:%M:%S UTC")
          
          ## Файли
          - `bzImage` - Ядро ZalupaOS
          - `.config` - Конфігурація ядра
          
          ## Особливості
          - Мінімальне ядро x86_64
          - Підтримка серійної консолі
          - Без initramfs
          - Оптимізовано для ZalupaOS
        prerelease: ${{ github.event.inputs.release_type != 'stable' }}
        files: |
          ${{ env.KERNEL_DIR }}/arch/x86/boot/bzImage
          ${{ env.KERNEL_DIR }}/.config
