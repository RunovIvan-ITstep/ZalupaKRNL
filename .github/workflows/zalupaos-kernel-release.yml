# .github/workflows/zalupaos-kernel-release.yml
name: Build ZalupaOS Kernel Release

on:
  push:
    tags: ['v*', 'zalupaos-*']
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Ð¢Ð¸Ð¿ Ñ€ÐµÐ»Ñ–Ð·Ñƒ'
        required: true
        default: 'beta'
        type: choice
        options:
          - stable
          - beta
          - alpha

permissions:
  contents: write

jobs:
  build-zalupaos-kernel:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout ZalupaOS
      uses: actions/checkout@v4
      
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libncurses-dev \
          flex \
          bison \
          libssl-dev \
          libelf-dev \
          bc \
          cpio \
          wget \
          file \
          pkg-config
          
    - name: Determine ZalupaOS version
      id: version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION="${GITHUB_REF#refs/tags/}"
        else
          COMMIT_SHORT="${GITHUB_SHA:0:8}"
          VERSION="zalupaos-$(date +%Y.%m.%d)-${{ github.event.inputs.release_type || 'beta' }}+${COMMIT_SHORT}"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "KERNEL_VERSION=6.1.58" >> $GITHUB_ENV
        
    - name: Download Linux kernel
      run: |
        wget -q https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-${{ env.KERNEL_VERSION }}.tar.xz
        tar -xf linux-${{ env.KERNEL_VERSION }}.tar.xz
        echo "KERNEL_DIR=linux-${{ env.KERNEL_VERSION }}" >> $GITHUB_ENV
        
    - name: Configure ZalupaOS kernel
      run: |
        cd $KERNEL_DIR
        make defconfig
        
        # Ð’Ð¸Ð¼ÐºÐ½ÑƒÑ‚Ð¸ Ð½ÐµÐ¿Ð¾Ñ‚Ñ€Ñ–Ð±Ð½Ñ– Ñ„ÑƒÐ½ÐºÑ†Ñ–Ñ— Ð´Ð»Ñ Ð¼Ñ–Ð½Ñ–Ð¼Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÑÐ´Ñ€Ð°
        ./scripts/config --disable CONFIG_STACK_VALIDATION
        ./scripts/config --disable CONFIG_UNWINDER_ORC
        ./scripts/config --disable CONFIG_DEBUG_INFO
        ./scripts/config --disable CONFIG_MODULES
        
        # Ð‘Ð°Ð·Ð¾Ð²Ñ– Ð½Ð°Ð»Ð°ÑˆÑ‚ÑƒÐ²Ð°Ð½Ð½Ñ Ð´Ð»Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ð¸
        ./scripts/config --enable CONFIG_SERIAL_8250
        ./scripts/config --enable CONFIG_SERIAL_8250_CONSOLE
        ./scripts/config --enable CONFIG_DEVTMPFS
        ./scripts/config --enable CONFIG_DEVTMPFS_MOUNT
        ./scripts/config --enable CONFIG_BLK_DEV_INITRD
        ./scripts/config --enable CONFIG_PRINTK
        ./scripts/config --enable CONFIG_TTY
        ./scripts/config --enable CONFIG_64BIT
        
        # Ð’ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ð¸ Ð½Ð°Ð·Ð²Ñƒ ÑÐ¸ÑÑ‚ÐµÐ¼Ð¸
        ./scripts/config --set-str CONFIG_LOCALVERSION "-zalupaos"
        ./scripts/config --set-str CONFIG_SYSFS_DEPRECATED "n"
        
    - name: Build ZalupaOS kernel
      run: |
        cd $KERNEL_DIR
        make -j$(nproc) bzImage
        
        # ÐŸÐµÑ€ÐµÐ¹Ð¼ÐµÐ½ÑƒÐ²Ð°Ñ‚Ð¸ ÑÐ´Ñ€Ð¾ Ð´Ð»Ñ ZalupaOS
        cp arch/x86/boot/bzImage zalupaos-kernel-${{ env.VERSION }}
        
    - name: Create ZalupaOS initramfs
      run: |
        mkdir -p zalupaos-initramfs
        cat > zalupaos-initramfs/init.c << 'EOF'
#include <stdio.h>
#include <unistd.h>

int main() {
    printf("\n");
    printf("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n");
    printf("â•‘            ZalupaOS Kernel             â•‘\n");
    printf("â•‘              Version: %-15s â•‘\n", "${{ env.VERSION }}");
    printf("â•‘                                        â•‘\n");
    printf("â•‘    Built with GitHub Actions           â•‘\n");
    printf("â•‘    Kernel: 6.1.58                     â•‘\n");
    printf("â•‘                                        â•‘\n");
    printf("â•‘    System is running successfully!     â•‘\n");
    printf("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
    printf("\n");
    
    // ÐŸÑ€Ð¾ÑÑ‚Ð° Ð¾Ð±Ð¾Ð»Ð¾Ð½ÐºÐ°
    printf("zalupaos> ");
    fflush(stdout);
    
    while(1) {
        sleep(60);
        printf("\nzalupaos> ");
        fflush(stdout);
    }
    
    return 0;
}
EOF
        gcc -static -Os -o zalupaos-initramfs/init zalupaos-initramfs/init.c
        cd zalupaos-initramfs && find . | cpio -o -H newc | gzip > ../zalupaos-initramfs-${{ env.VERSION }}.cpio.gz
        
    - name: Create kernel info file
      run: |
        cat > zalupaos-kernel-info.txt << EOF
ZalupaOS Kernel Information
===========================

Kernel Version: ${{ env.VERSION }}
Linux Version: ${{ env.KERNEL_VERSION }}
Build Date: $(date -u "+%Y-%m-%d %H:%M:%S UTC")
Git Commit: ${{ github.sha }}
Build System: GitHub Actions

Features:
- Minimal x86_64 kernel
- Serial console support
- Initramfs with basic shell
- Optimized for embedded use

Usage:
  qemu-system-x86_64 \\
    -kernel zalupaos-kernel-${{ env.VERSION }} \\
    -initrd zalupaos-initramfs-${{ env.VERSION }}.cpio.gz \\
    -append "console=ttyS0 quiet" \\
    -nographic \\
    -m 512M

ZalupaOS - Ð›ÐµÐ³ÐºÐ° Ñ‚Ð° ÐµÑ„ÐµÐºÑ‚Ð¸Ð²Ð½Ð° Ð¾Ð¿ÐµÑ€Ð°Ñ†Ñ–Ð¹Ð½Ð° ÑÐ¸ÑÑ‚ÐµÐ¼Ð°!
EOF
        
    - name: Create ZalupaOS release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.VERSION }}
        name: "ZalupaOS Kernel ${{ env.VERSION }}"
        body: |
          # ðŸ§ ZalupaOS Kernel Release
          
          **Ð’ÐµÑ€ÑÑ–Ñ:** ${{ env.VERSION }}  
          **Ð¯Ð´Ñ€Ð¾ Linux:** ${{ env.KERNEL_VERSION }}  
          **Ð”Ð°Ñ‚Ð° Ð·Ð±Ñ–Ñ€ÐºÐ¸:** $(date -u "+%Y-%m-%d %H:%M:%S UTC")  
          
          ## ðŸ“¦ Ð’Ð¼Ñ–ÑÑ‚ Ñ€ÐµÐ»Ñ–Ð·Ñƒ
          
          - `zalupaos-kernel-*` - Ð’Ð»Ð°ÑÐ½Ðµ ÑÐ´Ñ€Ð¾ ZalupaOS
          - `zalupaos-initramfs-*.cpio.gz` - Initramfs Ð´Ð»Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ð¸
          - `zalupaos-kernel-info.txt` - Ð†Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ñ–Ñ Ð¿Ñ€Ð¾ Ð·Ð±Ñ–Ñ€ÐºÑƒ
          - `.config` - ÐšÐ¾Ð½Ñ„Ñ–Ð³ÑƒÑ€Ð°Ñ†Ñ–Ñ ÑÐ´Ñ€Ð°
          
          ## ðŸš€ Ð¯Ðº Ð²Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÐ²Ð°Ñ‚Ð¸
          
          ```bash
          # Ð—Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶Ñ‚Ðµ Ñ„Ð°Ð¹Ð»Ð¸ Ð· Ñ€ÐµÐ»Ñ–Ð·Ñƒ
          # Ð—Ð°Ð¿ÑƒÑÑ‚Ñ–Ñ‚ÑŒ Ð² QEMU (Ð´Ð»Ñ Ñ‚ÐµÑÑ‚ÑƒÐ²Ð°Ð½Ð½Ñ)
          qemu-system-x86_64 \\
            -kernel zalupaos-kernel-${{ env.VERSION }} \\
            -initrd zalupaos-initramfs-${{ env.VERSION }}.cpio.gz \\
            -append "console=ttyS0" \\
            -nographic \\
            -m 512M
          ```
          
          ## ðŸ”§ ÐžÑÐ¾Ð±Ð»Ð¸Ð²Ð¾ÑÑ‚Ñ–
          
          - ÐœÑ–Ð½Ñ–Ð¼Ð°Ð»ÑŒÐ½Ðµ ÑÐ´Ñ€Ð¾ Ð´Ð»Ñ ZalupaOS
          - ÐŸÑ–Ð´Ñ‚Ñ€Ð¸Ð¼ÐºÐ° x86_64 Ð°Ñ€Ñ…Ñ–Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð¸
          - Ð’Ð±ÑƒÐ´Ð¾Ð²Ð°Ð½Ð° initramfs Ð· Ð±Ð°Ð·Ð¾Ð²Ð¾ÑŽ Ð¾Ð±Ð¾Ð»Ð¾Ð½ÐºÐ¾ÑŽ
          - ÐžÐ¿Ñ‚Ð¸Ð¼Ñ–Ð·Ð¾Ð²Ð°Ð½Ð¾ Ð´Ð»Ñ embedded ÑÐ¸ÑÑ‚ÐµÐ¼
          
          **ZalupaOS** - Ð£ÐºÑ€Ð°Ñ—Ð½ÑÑŒÐºÐ° Ð»ÐµÐ³ÐºÐ° Ð¾Ð¿ÐµÑ€Ð°Ñ†Ñ–Ð¹Ð½Ð° ÑÐ¸ÑÑ‚ÐµÐ¼Ð°!
        prerelease: ${{ github.event.inputs.release_type != 'stable' }}
        draft: false
        files: |
          ${{ env.KERNEL_DIR }}/zalupaos-kernel-${{ env.VERSION }}
          zalupaos-initramfs-${{ env.VERSION }}.cpio.gz
          zalupaos-kernel-info.txt
          ${{ env.KERNEL_DIR }}/.config
