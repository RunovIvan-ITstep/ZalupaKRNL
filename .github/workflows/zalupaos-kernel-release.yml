# .github/workflows/zalupaos-buildroot.yml
name: Build ZalupaOS with Buildroot

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget cpio
        
    - name: Download Buildroot
      run: |
        wget -q https://buildroot.org/downloads/buildroot-2024.02.1.tar.gz
        tar -xf buildroot-2024.02.1.tar.gz
        echo "BUILDROOT_DIR=buildroot-2024.02.1" >> $GITHUB_ENV
        
    - name: Configure minimal system
      run: |
        cd $BUILDROOT_DIR
        make defconfig
        # Мінімальна конфігурація
        echo "BR2_x86_64=y" > .config
        echo "BR2_TOOLCHAIN_BUILDROOT_GLIBC=y" >> .config
        echo "BR2_SYSTEM_DHCP=\"eth0\"" >> .config
        echo "BR2_TARGET_GENERIC_GETTY_PORT=\"ttyS0\"" >> .config
        
    - name: Build with Buildroot
      run: |
        cd $BUILDROOT_DIR
        make -j$(nproc)
        
    - name: Create release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: zalupaos-buildroot-v1
        name: ZalupaOS Buildroot
        body: |
          Complete system with kernel and rootfs
          
          Files:
          - **bzImage** - Linux kernel
          - **rootfs.cpio** - Root filesystem  
          - **rootfs.tar** - Root filesystem archive
        files: |
          $BUILDROOT_DIR/output/images/bzImage
          $BUILDROOT_DIR/output/images/rootfs.cpio
          $BUILDROOT_DIR/output/images/rootfs.tar