# .github/workflows/zalupaos-kernel.yml
name: Build ZalupaOS Kernel

on:
  push:
    tags: ['v*']
  workflow_dispatch:

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libssl-dev libelf-dev bc wget
          
    - name: Get version
      id: version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION="${GITHUB_REF#refs/tags/}"
        else
          VERSION="zalupaos-$(date +%Y.%m.%d)"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "KERNEL_VERSION=6.1.58" >> $GITHUB_ENV
        
    - name: Download kernel
      run: |
        wget -q https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-${{ env.KERNEL_VERSION }}.tar.xz
        tar -xf linux-${{ env.KERNEL_VERSION }}.tar.xz
        echo "KERNEL_DIR=linux-${{ env.KERNEL_VERSION }}" >> $GITHUB_ENV
        
    - name: Configure kernel
      run: |
        cd $KERNEL_DIR
        make allnoconfig
        
        ./scripts/config --enable CONFIG_64BIT
        ./scripts/config --enable CONFIG_SERIAL_8250
        ./scripts/config --enable CONFIG_SERIAL_8250_CONSOLE
        ./scripts/config --enable CONFIG_PRINTK
        ./scripts/config --enable CONFIG_TTY
        ./scripts/config --enable CONFIG_LOGO
        ./scripts/config --enable CONFIG_LOGO_LINUX_CLUT224
        
        ./scripts/config --disable CONFIG_BLOCK
        ./scripts/config --disable CONFIG_BLK_DEV_INITRD
        
    - name: Build kernel
      run: |
        cd $KERNEL_DIR
        make -j$(nproc) bzImage
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.VERSION }}
        name: "ZalupaOS Kernel ${{ env.VERSION }}"
        body: "ZalupaOS Kernel with Tux logo"
        draft: false
        prerelease: false
        files: |
          ${{ env.KERNEL_DIR }}/arch/x86/boot/bzImage