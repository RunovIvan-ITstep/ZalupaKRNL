# .github/workflows/zalupaos-kernel.yml
name: Build ZalupaOS Kernel

on:
  push:
    tags: ['v*', 'zalupaos-*']
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libssl-dev libelf-dev bc wget
          
    - name: Get version
      id: version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION="${GITHUB_REF#refs/tags/}"
        else
          VERSION="zalupaos-$(date +%Y.%m.%d)"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "KERNEL_VERSION=6.1.58" >> $GITHUB_ENV
        
    - name: Download kernel
      run: |
        wget -q https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-${{ env.KERNEL_VERSION }}.tar.xz
        tar -xf linux-${{ env.KERNEL_VERSION }}.tar.xz
        echo "KERNEL_DIR=linux-${{ env.KERNEL_VERSION }}" >> $GITHUB_ENV
        
    - name: Configure kernel (NO ROOT FS)
      run: |
        cd $KERNEL_DIR
        make allnoconfig
        
        # ТІЛЬКИ ці опції
        ./scripts/config --enable CONFIG_64BIT
        ./scripts/config --enable CONFIG_SERIAL_8250
        ./scripts/config --enable CONFIG_SERIAL_8250_CONSOLE
        ./scripts/config --enable CONFIG_PRINTK
        ./scripts/config --enable CONFIG_TTY
        
        # ВИМКНУТИ ВСЕ що пов'язано з файловими системами
        ./scripts/config --disable CONFIG_BLOCK
        ./scripts/config --disable CONFIG_BLK_DEV
        ./scripts/config --disable CONFIG_BLK_DEV_INITRD
        ./scripts/config --disable CONFIG_DEVTMPFS
        ./scripts/config --disable CONFIG_PROC_FS
        ./scripts/config --disable CONFIG_SYSFS
        
        # Tux логотип
        ./scripts/config --enable CONFIG_LOGO
        ./scripts/config --enable CONFIG_LOGO_LINUX_CLUT224
        
    - name: Build kernel
      run: |
        cd $KERNEL_DIR
        make -j$(nproc) bzImage
        
    - name: Test kernel
      run: |
        cd $KERNEL_DIR
        timeout 10s qemu-system-x86_64 -kernel arch/x86/boot/bzImage -append "console=ttyS0" -nographic -m 64M || echo "Test completed"
        
    - name: Create release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.VERSION }}
        name: "ZalupaOS Kernel ${{ env.VERSION }}"
        body: |
          # ZalupaOS Kernel
          
          **Version:** ${{ env.VERSION }}
          
          ## Run command:
          ```bash
          qemu-system-x86_64 -kernel bzImage -append "console=ttyS0" -nographic
          ```
        prerelease: true
        files: |
          ${{ env.KERNEL_DIR }}/arch/x86/boot/bzImage