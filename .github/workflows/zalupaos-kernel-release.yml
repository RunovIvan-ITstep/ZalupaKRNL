# .github/workflows/zalupaos-kernel.yml
name: Build ZalupaOS Kernel

on:
  workflow_dispatch:

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libssl-dev libelf-dev bc wget
          
    - name: Download and configure kernel
      run: |
        wget -q https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.1.58.tar.xz
        tar -xf linux-6.1.58.tar.xz
        cd linux-6.1.58
        
        # МІНІМАЛЬНА конфігурація
        make allnoconfig
        
        # ТІЛЬКИ ці 4 опції
        echo "CONFIG_64BIT=y" >> .config
        echo "CONFIG_SERIAL_8250=y" >> .config
        echo "CONFIG_SERIAL_8250_CONSOLE=y" >> .config
        echo "CONFIG_PRINTK=y" >> .config
        
        # ВИМКНУТИ ВСЕ інше
        echo "CONFIG_BLOCK=n" >> .config
        echo "CONFIG_BLK_DEV_INITRD=n" >> .config
        
    - name: Build kernel
      run: |
        cd linux-6.1.58
        make -j$(nproc) bzImage
        
    - name: Create release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: zalupaos-$(date +%Y.%m.%d)
        name: "ZalupaOS Kernel"
        body: "Minimal kernel without root filesystem"
        files: |
          linux-6.1.58/arch/x86/boot/bzImage